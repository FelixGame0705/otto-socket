<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Socket Room Test</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
      .row { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
      input, button { padding: 8px 12px; font-size: 14px; }
      button { cursor: pointer; }
      #log { border: 1px solid #ddd; padding: 12px; min-height: 160px; white-space: pre-wrap; }
      .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    </style>
  </head>
  <body>
    <h1>Socket.IO Room Test</h1>
    <div class="row" style="margin-bottom: 0">
      <strong>Status:</strong>
      <span id="status" style="padding:2px 6px;border:1px solid #ddd;border-radius:4px">idle</span>
    </div>
    <div class="row">
      <label>Room ID:</label>
      <input id="roomId" placeholder="enter room id" />
      <button id="connectBtn">Connect & Join</button>
    </div>
    <div class="actions">
      <button data-action="forward">forward</button>
      <button data-action="turnRight">turnRight</button>
      <button data-action="turnLeft">turnLeft</button>
      <button data-action="turnBack">turnBack</button>
    </div>
    <div class="row">
      <input id="seq" style="flex:1" placeholder="sequence (comma-separated), e.g. forward,turnRight,turnLeft" />
      <input id="delay" type="number" min="0" step="50" value="0" style="width:140px" placeholder="delay ms" />
      <button id="sendSeq">Send sequence</button>
    </div>
    <h3>Log</h3>
    <div id="log"></div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-n+9aJ1fA9yGldrvHTX5a0F+K2iFUZKy+A9mG2RDPs8Y5m9oy+K+0wzvKxbnZQ4qE" crossorigin="anonymous"></script>
    <script>
      const log = (msg) => {
        const el = document.getElementById('log');
        const time = new Date().toLocaleTimeString();
        el.textContent += `[${time}] ${msg}\n`;
        el.scrollTop = el.scrollHeight;
      };

      const connectBtn = document.getElementById('connectBtn');
      const setStatus = (text, color = '#333') => {
        const el = document.getElementById('status');
        el.textContent = text;
        el.style.color = color;
      };
      let socket;

      connectBtn.addEventListener('click', () => {
        const roomId = document.getElementById('roomId').value.trim();
        if (!roomId) { alert('Please enter room id'); return; }
        if (socket) { socket.disconnect(); }
        // Allow both polling and websocket (polling first for reliability), explicit path and absolute URL
        setStatus('connecting...', '#8a6d3b');
        log('connecting to ' + window.location.origin + ' ...');
        const socket = io('http://localhost:3000', { path: '/socket.io', transports: ['polling'] });
        socket.on('connect', () => {
          log('connected ' + socket.id);
          setStatus('connected', '#3c763d');
          socket.emit('join', { id: roomId });
        });
        socket.on('joined', (data) => log('joined room ' + data.roomId));
        socket.on('history', (data) => log('history actions: ' + JSON.stringify(data.actions)));
        socket.on('actions', (data) => log('actions(array): ' + JSON.stringify(data)));
        socket.on('disconnect', () => { log('disconnected'); setStatus('disconnected', '#a94442'); });
        socket.on('error', (e) => { log('error: ' + JSON.stringify(e)); setStatus('error', '#a94442'); });
        socket.on('connect_error', (e) => { log('connect_error: ' + (e && e.message || JSON.stringify(e))); setStatus('connect_error', '#a94442'); });
        socket.on('connect_timeout', () => { log('connect_timeout'); setStatus('connect_timeout', '#a94442'); });
        socket.io.on('error', (e) => log('io error: ' + JSON.stringify(e)));
        socket.io.on('reconnect_error', (e) => log('reconnect_error: ' + JSON.stringify(e)));
        socket.io.on('reconnect_attempt', (n) => log('reconnect_attempt: ' + n));
        socket.io.on('open', () => log('transport open: ' + socket.io.engine.transport.name));
      });

      document.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const action = btn.getAttribute('data-action');
          const roomId = document.getElementById('roomId').value.trim();
          if (!roomId) { alert('Please enter room id'); return; }
          const res = await fetch('/sendActions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: roomId, action }),
          });
          const data = await res.json().catch(() => ({}));
          log('HTTP: ' + res.status + ' ' + JSON.stringify(data));
        });
      });

      document.getElementById('sendSeq').addEventListener('click', async () => {
        const roomId = document.getElementById('roomId').value.trim();
        if (!roomId) { alert('Please enter room id'); return; }
        const text = document.getElementById('seq').value.trim();
        const delayMs = parseInt(document.getElementById('delay').value, 10) || 0;
        const actions = text.split(',').map(s => s.trim()).filter(Boolean);
        if (!actions.length) { alert('Please enter at least one action'); return; }
        const res = await fetch('/sendActions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: roomId, actions, delayMs }),
        });
        const data = await res.json().catch(() => ({}));
        log('HTTP: ' + res.status + ' ' + JSON.stringify(data));
      });
    </script>
  </body>
  </html>


